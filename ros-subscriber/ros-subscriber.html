<script type="text/javascript">
	$.getJSON('packages', function(list) {
		window.list = list

		var o = ""
		var o2 = []
		for (var key in window.list) {
			if (window.list.hasOwnProperty(key)) {
				o += '<option value="' + key + '">' + key + '</option>'
				o2.push(key)
			}
		}
		window.list_package_html = o
		window.list_package = o2
	})

	RED.nodes.registerType('ros-subscriber', {
		category: 'ROS',
		color: '#fef5ff',
		defaults: {
			node: {
				type: "ros-node-config"
			},
			topicname: {
				value: "",
				required: true
			},
			typepackage: {
				validate: function(v) {
					return (window.list_package.indexOf(v) > -1)
				},
				required: true
			},
			typename: {
				validate: function(v) {
					return (window.list_package.indexOf(this.typepackage) > -1) && (window.list[this.typepackage].indexOf(v) > -1)
				},
				required: true
			}
		},
		inputs: 0,
		outputs: 1,
		paletteLabel: 'subscriber',
		icon: "ros_logo.png",
		label: function() {
			return this.topicname || "ros subscriber"
		},
		oneditprepare: function() {
			var node = this;

			if (!node.typepackage) {
				node.typepackage = 'std_msgs'
			}

			if (!node.typename) {
				node.typename = 'String'
			}

			$('#node-input-typepackage')
				.html(window.list_package_html)
				.val(node.typepackage)

			var loadPackage = function() {
				var ar2 = window.list[node.typepackage]

				var o = ""
				for (var i = 0; i < ar2.length; i++) {
					o += '<option value="' + ar2[i] + '">' + ar2[i] + '</option>'
				}

				$('#node-input-typename').html(o)
				$("#node-input-typename")
					.val(node.typename)
			}


			$('#node-input-typepackage').change(function() {
				node.typepackage = this.value
				loadPackage()
			})
			loadPackage()
		}
	})
</script>

<script type="text/x-red" data-template-name="ros-subscriber">
	<div class="form-row">
		<label for="node-input-node"><i class="fa fa-user"></i> ROS Node</label>
		<input type="text" id="node-input-node">
	</div>
	<div class="form-row">
		<label for="node-input-topicname"><i class="icon-tag"></i> Topic</label>
		<input type="text" id="node-input-topicname" placeholder="/mytopic">
	</div>

	<div class="form-row">
		<label for="node-input-typepackage">Datatype package</label>
		<select id="node-input-typepackage"></select>
	</div>

	<div class="form-row">
		<label for="node-input-typename">Datatype</label>
		<select id="node-input-typename"></select>
	</div>
</script>


<script type="text/x-red" data-help-name="ros-subscriber">
	<p>A node that subscribe to a ROS topic</p>
</script>
